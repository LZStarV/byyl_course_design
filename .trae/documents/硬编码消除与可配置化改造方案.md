## 项目架构综述
- 词法层：`RegexLexer` 读取规则文本并识别宏与 Token 头（src/regex）。`RegexParser` 解析为抽象语法树 AST，并提取字母表 `Alphabet`（src/regex）。
- 自动机构建：Thompson 构造 RE→NFA（src/automata/Thompson），子集构造 NFA→DFA（src/automata/SubsetConstruction），Hopcroft 最小化 DFA→MinDFA（src/automata/Hopcroft）。数据结构在 `src/model/Automata.h`。
- 流水线封装：`Engine` 将 lex→parse→NFA→DFA→MinDFA 统一为接口，并提供状态表视图与运行器（src/Engine.cpp）。
- 代码生成：`CodeGenerator` 从 MinDFA 生成 C++ 源码，支持单 DFA 与组合扫描器（src/generator/CodeGenerator.cpp）。
- GUI：`MainWindow` 提供正则编辑、状态表展示、代码生成与运行测试（app/mainwindow.cpp）。
- 测试：命令行与代码生成闭环测试（tests/*）。构建使用 CMake（CMakeLists.txt）。

## 已发现的硬编码点
- 权重阈值（影响并列最优匹配的 tie-break）：
  - `src/Engine.cpp:38` 使用固定阈值 `>=220 →3, >=200 →4, >=100 →1, else 0`。
  - 同样逻辑被嵌入到生成器源码中：`src/generator/CodeGenerator.cpp:95–101`。
- 生成输出目录：`app/mainwindow.cpp:278` 将生成代码目录固定为 `../../generated/lex`。
- 其他：测试中存在路径回退策略，但无绝对路径硬编码；字母/数字分类返回值为内部约定（非外部配置），无需改造。

## 改造目标
- 消除硬编码阈值与固定路径，改为从配置或输入源动态获取；保持现有功能与默认行为不变。
- 运行时（Engine）与生成器（CodeGenerator 产出的独立程序）均可通过配置或环境变量覆盖默认值。
- 添加注释、测试与文档，保证跨环境可用。

## 技术方案
### 配置模型
- 新增 `config/lexer.json`（工程侧）示例结构：
  - `generated_output_dir`: 生成代码保存目录（字符串）。
  - `weight_tiers`: 阶梯数组，按优先级从高到低：`[{"min_code":220,"weight":3},{"min_code":200,"weight":4},{"min_code":100,"weight":1},{"min_code":0,"weight":0}]`。
- 环境变量兜底：
  - `BYYL_GEN_DIR`: 覆盖生成输出目录。
  - `LEXER_WEIGHTS`: 为生成器可读的轻量格式，例如 `220:3,200:4,100:1,0:0`。

### 代码改造
- `src/config/Config.h/.cpp`（新增）：
  - 提供 `Config::load()` 读取 `config/lexer.json`（Qt JSON），并缓存。
  - 提供 `int Config::weightForCode(int c)`：按 `weight_tiers` 计算权重，若无配置则使用当前默认阈值，保持行为不变。
  - 提供 `QString Config::generatedOutputDir()`：优先 `BYYL_GEN_DIR`，否则读取 JSON，最后回退到 `../../generated/lex`。
- `src/Engine.cpp`：
  - 移除静态 `codeWeight` lambda（现位于 38 行）。
  - 在 `runMultiple` 使用 `Config::weightForCode(codes[i])`。
  - 添加简短注释，说明权重来源于配置（含默认回退）。
- `app/mainwindow.cpp`：
  - `ensureGenDir()` 改为调用 `Config::generatedOutputDir()`，保持目录创建逻辑不变。
  - 添加简短注释说明目录来源与覆盖方式。
- `src/generator/CodeGenerator.cpp`（影响生成的独立程序）：
  - 删除硬编码的 `codeWeight()` 阈值函数；替换为可读取环境变量的实现：
    - 在生成的源码中加入一个解析 `LEXER_WEIGHTS` 的轻量函数（纯 `std`，无需第三方库），解析失败时使用与工程侧相同的默认阈值，保证向后兼容。
  - 保持其他生成逻辑与接口不变，确保既有测试与 GUI 功能工作。

### 注释策略
- 在上述改动点添加简短注释：
  - 解释权重/路径值来源（配置/环境变量/默认回退），说明计算逻辑与优先级。
  - 注释仅限关键入口函数与配置读写处，避免污染业务逻辑。

## 全项目硬编码扫描与处理
- 针对数值与路径进行扫描：
  - 使用模式 `>=\d+`、`return \d+;`、`generated/lex`、`QCoreApplication::applicationDirPath()` 路径组装等。
  - 已确认主要硬编码集中在权重与生成目录，其余为测试输入与内部约定，不需外部配置化。
- 扫描报告将附在提交说明中，列出变更点与保留点。

## 测试与验证
- 新增单元测试：
  - `tests/config_weight_test.cpp`：模拟不同 `weight_tiers` 与 `LEXER_WEIGHTS`，验证并列匹配的权重决策与默认回退。
  - `tests/gen_dir_config_test.cpp`：设置 `BYYL_GEN_DIR` 后生成代码路径正确；无环境变量/无 JSON 时回退到默认目录。
- 现有测试保持通过：`CliRegexTest` 与 `CodegenTest` 无需改动。
- 在 CI 或本地两种编译环境（macOS clang++ 与 Linux g++/clang++）执行编译与测试，确保无 Qt 版本依赖差异。

## 文档更新
- 更新 `README.md`：
  - 增加 `config/lexer.json` 字段说明、环境变量覆盖方式、生成器对 `LEXER_WEIGHTS` 的支持。
  - 给出示例与推荐约定（代码区间与权重含义）。

## 提交与变更说明
- 在版本控制中分步提交：
  - 提交 1：新增 `Config` 模块与工程侧接入（Engine/MainWindow）。
  - 提交 2：生成器源码模板调整（环境变量权重解析）。
  - 提交 3：新增测试与 README 更新。
- 每次提交包含：扫描发现、改动文件、默认回退策略与兼容性说明。

## 兼容性与回退
- 若配置缺失或解析失败：
  - 工程侧与生成器均回退到当前硬编码逻辑，保证行为不变。
- 保持 API 与既有测试不变，避免破坏外部使用方式。
