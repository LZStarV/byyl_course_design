<mxfile host="65bd71144e">
    <diagram id="ThompsonFlowCompact" name="Thompson NFA Build (Compact)">
        <mxGraphModel dx="1345" dy="1014" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1000" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="n_start" value="开始：输入 AST 根与字母表" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="60" y="330" width="240" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="n_call" value="调用构造：buildFrom(ast)" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="60" y="500" width="240" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="n_decide" value="节点类型判定" style="shape=rhombus;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="70" y="650" width="220" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="n_symbol" value="原子片段：&lt;div&gt;初始化 p 为头尾片段&lt;/div&gt;&lt;div&gt;添加符号边：s→t&lt;/div&gt;&lt;div&gt;输出片段：p&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="1710" y="940" width="140" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="n_charset" value="字符类片段：&lt;div&gt;初始化 p 为头尾片段&lt;/div&gt;&lt;div&gt;为集合内每字符添加边：s→t&lt;/div&gt;&lt;div&gt;输出片段：p&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="1520" y="940" width="170" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="n_concat" value="连接：&lt;div&gt;生成左右片段：a、b&lt;/div&gt;&lt;div&gt;添加 ε 边：a.second → b.first&lt;/div&gt;&lt;div&gt;取消 a.second 为接受&lt;/div&gt;&lt;div&gt;输出片段：{a.first, b.second}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="800" y="920" width="200" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="n_union" value="选择：&lt;div&gt;生成分支：a、b&lt;/div&gt;&lt;div&gt;初始化 p 为头尾片段&lt;/div&gt;&lt;div&gt;p.first 以 ε 到 a.first 与 b.first&lt;/div&gt;&lt;div&gt;a.second 与 b.second 以 ε 到 p.second&lt;/div&gt;&lt;div&gt;清除分支尾的接受&lt;/div&gt;&lt;div&gt;输出片段：p&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="1030" y="905" width="220" height="150" as="geometry"/>
                </mxCell>
                <mxCell id="n_star" value="闭包：&lt;div&gt;生成分支：a&lt;/div&gt;&lt;div&gt;初始化 p 为头尾片段&lt;/div&gt;&lt;div&gt;p.first 以 ε 到 a.first 与 p.second&lt;/div&gt;&lt;div&gt;a.second 以 ε 到 p.second 与 a.first&lt;/div&gt;&lt;div&gt;清除 a.second 的接受&lt;/div&gt;&lt;div&gt;输出片段：p&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="1280" y="905" width="210" height="150" as="geometry"/>
                </mxCell>
                <mxCell id="3" style="edgeStyle=none;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="n_plus" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="640" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="n_plus" value="正闭包：&lt;div&gt;至少一次；&lt;/div&gt;&lt;div&gt;先完成一次连接（a），再追加闭包循环与出口；&lt;/div&gt;&lt;div&gt;输出 {head,tail}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="510" y="930" width="260" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="n_question" value="可选：&lt;div&gt;生成分支：a&lt;/div&gt;&lt;div&gt;初始化 p 为头尾片段&lt;/div&gt;&lt;div&gt;p.first 以 ε 到 a.first 与 p.second&lt;/div&gt;&lt;div&gt;a.second 以 ε 到 p.second&lt;/div&gt;&lt;div&gt;清除 a.second 的接受&lt;/div&gt;&lt;div&gt;输出片段：p&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="260" y="920" width="220" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="n_ref" value="引用：&lt;div&gt;展开为目标 AST；&lt;div&gt;返回类型判定&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="117.5" y="940" width="125" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="n_return" value="返回片段：&lt;div&gt;包含 first（片段头）与 second（片段尾）&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="1350" y="520" width="220" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="n_merge" value="多 Token 合并：&lt;div&gt;globalStart 以 ε 引入各片段头&lt;/div&gt;&lt;div&gt;通过偏移映射统一编号&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="1030" y="510" width="180" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="n_end" value="输出 NFA（起始/接受/字母表同步）" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
                    <mxGeometry x="600" y="530" width="300" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="e_start_call" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;" parent="1" source="n_start" target="n_call" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="e_call_decide" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;" parent="1" source="n_call" target="n_decide" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="e_decide_symbol" value="Symbol" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_symbol" edge="1">
                    <mxGeometry x="0.9075" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_charset" value="CharSet" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_charset" edge="1">
                    <mxGeometry x="0.8971" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_concat" value="Concat" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_concat" edge="1">
                    <mxGeometry x="0.871" relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="180" y="780"/>
                            <mxPoint x="900" y="780"/>
                        </Array>
                        <mxPoint y="-1" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_union" value="Union" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_union" edge="1">
                    <mxGeometry x="0.9147" relative="1" as="geometry">
                        <mxPoint x="180" y="750" as="sourcePoint"/>
                        <Array as="points">
                            <mxPoint x="180" y="780"/>
                            <mxPoint x="1140" y="780"/>
                        </Array>
                        <mxPoint y="-1" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_star" value="Star" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_star" edge="1">
                    <mxGeometry x="0.9338" relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="180" y="780"/>
                            <mxPoint x="1385" y="780"/>
                        </Array>
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_plus" value="Plus" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_plus" edge="1">
                    <mxGeometry x="0.7813" relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="180" y="780"/>
                            <mxPoint x="640" y="780"/>
                        </Array>
                        <mxPoint y="-1" as="offset"/>
                        <mxPoint x="610" y="830" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_question" value="Question" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;" parent="1" source="n_decide" target="n_question" edge="1">
                    <mxGeometry x="0.6521" relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="180" y="780"/>
                            <mxPoint x="355" y="780"/>
                        </Array>
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_decide_ref" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jettySize=auto;html=1;endArrow=block;endFill=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="n_decide" target="n_ref" edge="1">
                    <mxGeometry x="0.24" y="-45" relative="1" as="geometry">
                        <mxPoint x="180" y="850" as="targetPoint"/>
                        <Array as="points"/>
                        <mxPoint x="45" y="-45" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="2" value="Ref" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="e_decide_ref" vertex="1" connectable="0">
                    <mxGeometry x="-0.7013" y="1" relative="1" as="geometry">
                        <mxPoint x="-1" y="82" as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_symbol_return" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_symbol" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="2060" y="1120" as="sourcePoint"/>
                        <Array as="points">
                            <mxPoint x="1780" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_charset_return" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_charset" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="1605" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_concat_return" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_concat" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="1280" y="730" as="targetPoint"/>
                        <Array as="points">
                            <mxPoint x="900" y="1100"/>
                            <mxPoint x="1640" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_union_return" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_union" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="1140" y="1100"/>
                            <mxPoint x="1640" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_star_return" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_star" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="1640" y="790" as="targetPoint"/>
                        <Array as="points">
                            <mxPoint x="1385" y="1100"/>
                            <mxPoint x="1640" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_question_return" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_question" target="n_return" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="370" y="1100"/>
                            <mxPoint x="1280" y="1100"/>
                            <mxPoint x="1640" y="1100"/>
                            <mxPoint x="1880" y="1100"/>
                            <mxPoint x="1880" y="560"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_ref_decide" style="exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_ref" target="n_decide" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="160" y="750" as="targetPoint"/>
                        <Array as="points">
                            <mxPoint x="180" y="1100"/>
                            <mxPoint x="30" y="1100"/>
                            <mxPoint x="30" y="700"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="e_return_merge" style="entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="n_return" target="n_merge" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="e_merge_end" style="exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="n_merge" target="n_end" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>